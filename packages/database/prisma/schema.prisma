// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// SHARED / CORE MODELS
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?
  name      String?
  avatar    String?
  role      UserRole @default(USER)
  status    Boolean  @default(true)

  // Relations
  pic       PICUser?      @relation("UserToPIC")
  crmContacts CRMContact[] @relation("UserToCRMContact")
  inventory InventoryItem[] @relation("UserToInventoryItem")
  registrationLinks RegistrationLink[] @relation("UserToRegistrationLink")
  auditLogs AuditLog[] @relation("UserToAuditLog")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  USER
  VIEWER
  STAFF
}

// ============================================================================
// PIC (Monitoring) MODULE MODELS
// ============================================================================

model PICUser {
  id      String  @id @default(cuid())
  userId  String  @unique
  user    User    @relation("UserToPIC", fields: [userId], references: [id], onDelete: Cascade)
  department String?
  location String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pic_users")
}

model DNPMonitoring {
  id        String   @id @default(cuid())
  name      String
  location  String
  status    MonitoringStatus @default(ACTIVE)
  type      String?
  data      Json?
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dnp_monitoring")
}

enum MonitoringStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  OFFLINE
}

// ============================================================================
// CRM MODULE MODELS
// ============================================================================

model CRMContact {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserToCRMContact", fields: [userId], references: [id], onDelete: Cascade)
  name      String
  email     String?
  phone     String?
  whatsapp  String?
  company   String?
  notes     String?
  tags      String[]   @default([])
  status    ContactStatus @default(ACTIVE)

  // Campaign tracking
  campaigns CRMCampaign[] @relation("ContactToCampaign")
  logs      CRMLog[]      @relation("ContactToLog")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("crm_contacts")
}

enum ContactStatus {
  ACTIVE
  INACTIVE
  BLOCKED
  UNSUBSCRIBED
}

model CRMCampaign {
  id        String   @id @default(cuid())
  name      String
  type      CampaignType
  status    CampaignStatus @default(DRAFT)
  subject   String?
  content   String
  template  String?
  
  // Targeting
  contacts  CRMContact[] @relation("ContactToCampaign")
  tags      String[]   @default([])

  // Statistics
  totalSent   Int @default(0)
  totalSuccess Int @default(0)
  totalFailed  Int @default(0)
  openRate    Float @default(0)
  clickRate   Float @default(0)

  // Schedule
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("crm_campaigns")
}

enum CampaignType {
  EMAIL
  WHATSAPP
  SMS
  BOTH
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

model CRMLog {
  id        String   @id @default(cuid())
  contactId String
  contact   CRMContact @relation("ContactToLog", fields: [contactId], references: [id], onDelete: Cascade)
  action    String
  type      String    // 'email_sent', 'whatsapp_sent', 'email_opened', etc.
  status    String    // 'success', 'failed', 'pending'
  message   String?
  metadata  Json?

  createdAt DateTime @default(now())

  @@map("crm_logs")
}

// ============================================================================
// INVENTORY MODULE MODELS
// ============================================================================

model InventoryItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserToInventoryItem", fields: [userId], references: [id], onDelete: Cascade)
  sku       String   @unique
  name      String
  description String?
  category  String?
  quantity  Int      @default(0)
  minimumStock Int  @default(10)
  unit      String   @default("pcs")
  price     Float
  cost      Float?
  supplier  String?
  location  String?
  status    InventoryStatus @default(ACTIVE)
  image     String?

  // Tracking
  movements InventoryMovement[] @relation("ItemToMovement")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("inventory_items")
  @@index([sku])
  @@index([category])
}

enum InventoryStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
  RESERVED
}

model InventoryMovement {
  id        String   @id @default(cuid())
  itemId    String
  item      InventoryItem @relation("ItemToMovement", fields: [itemId], references: [id], onDelete: Cascade)
  type      MovementType
  quantity  Int
  reference String?    // reference ID for the movement (e.g., purchase order, sales order)
  notes     String?
  createdBy String?

  createdAt DateTime @default(now())

  @@map("inventory_movements")
  @@index([itemId])
  @@index([createdAt])
}

enum MovementType {
  IN         // Stock in / Purchase
  OUT        // Stock out / Sales
  ADJUSTMENT // Manual adjustment
  RETURN     // Return
  DAMAGE     // Damaged goods
}

// ============================================================================
// PICNEW (K3 Training) MODULE MODELS
// ============================================================================

model Bidang {
  id        String   @id @default(cuid())
  name      String   @unique  // e.g., "Kesehatan", "Keselamatan"
  code      String   @unique
  description String?

  // Relations
  trainingPrograms TrainingProgram[] @relation("BidangToTrainingProgram")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bidangs")
}

model TrainingProgram {
  id        String   @id @default(cuid())
  name      String   // e.g., "BNSP K3 Umum"
  code      String   @unique
  bidangId  String
  bidang    Bidang   @relation("BidangToTrainingProgram", fields: [bidangId], references: [id], onDelete: Cascade)
  duration  Int?     // in hours
  description String?

  // Relations
  classes   TrainingClass[] @relation("ProgramToClass")
  requiredDocuments RequiredDocument[] @relation("ProgramToRequiredDocument")
  registrationLinks RegistrationLink[] @relation("ProgramToLink")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("training_programs")
}

model TrainingClass {
  id        String   @id @default(cuid())
  name      String   // e.g., "Kelas A", "Kelas B"
  code      String   @unique
  trainingProgramId String
  trainingProgram TrainingProgram @relation("ProgramToClass", fields: [trainingProgramId], references: [id], onDelete: Cascade)
  personnelTypeIds String[]  // JSON array of personnelTypeIds
  maxParticipants Int  @default(30)

  // Relations
  registrations Registration[] @relation("ClassToRegistration")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("training_classes")
}

model PersonnelType {
  id        String   @id @default(cuid())
  name      String   @unique  // e.g., "Manager", "Supervisor", "Worker"
  code      String   @unique
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("personnel_types")
}

model DocumentType {
  id        String   @id @default(cuid())
  name      String   @unique  // e.g., "KTP", "Surat Izin Kerja"
  code      String   @unique
  description String?
  isMandatory Boolean @default(true)

  // Relations
  requiredDocuments RequiredDocument[] @relation("DocTypeToRequired")
  traineeDocuments TraineeDocument[] @relation("DocTypeToTrainee")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("document_types")
}

model RequiredDocument {
  id        String   @id @default(cuid())
  trainingProgramId String
  trainingProgram TrainingProgram @relation("ProgramToRequiredDocument", fields: [trainingProgramId], references: [id], onDelete: Cascade)
  documentTypeId String
  documentType DocumentType @relation("DocTypeToRequired", fields: [documentTypeId], references: [id], onDelete: Cascade)
  isMandatory Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([trainingProgramId, documentTypeId])
  @@map("required_documents")
}

model RegistrationLink {
  id        String   @id @default(cuid())
  code      String   @unique  // Auto-generated UUID
  trainingProgramId String
  trainingProgram TrainingProgram @relation("ProgramToLink", fields: [trainingProgramId], references: [id], onDelete: Cascade)
  createdBy String
  createdByUser User @relation("UserToRegistrationLink", fields: [createdBy], references: [id], onDelete: Restrict)
  maxRegistrations Int?  // null = unlimited
  status    LinkStatus @default(ACTIVE)
  expiredAt DateTime?

  // Relations
  registrations Registration[] @relation("LinkToRegistration")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("registration_links")
  @@index([code])
  @@index([trainingProgramId])
}

enum LinkStatus {
  ACTIVE
  INACTIVE
  EXPIRED
}

model Registration {
  id        String   @id @default(cuid())
  registrationLinkId String
  registrationLink RegistrationLink @relation("LinkToRegistration", fields: [registrationLinkId], references: [id], onDelete: Cascade)
  fullName  String
  email     String
  phoneNumber String
  bidang    String   // bidang name
  trainingClassId String?
  trainingClass TrainingClass? @relation("ClassToRegistration", fields: [trainingClassId], references: [id], onDelete: SetNull)
  personnelTypeId String?
  
  // Address
  provinceId String?
  regencyId  String?
  districtId String?
  villageId  String?
  address    String?

  status    RegistrationStatus @default(PENDING)
  rejectionReason String?
  submissionToken String @unique

  // Relations
  documents TraineeDocument[] @relation("RegistrationToDocument")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  approvedAt DateTime?

  @@map("registrations")
  @@index([registrationLinkId])
  @@index([status])
  @@index([submissionToken])
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

model TraineeDocument {
  id        String   @id @default(cuid())
  registrationId String
  registration Registration @relation("RegistrationToDocument", fields: [registrationId], references: [id], onDelete: Cascade)
  documentTypeId String
  documentType DocumentType @relation("DocTypeToTrainee", fields: [documentTypeId], references: [id], onDelete: Restrict)
  fileName  String
  fileUrl   String   // URL to cloud storage
  status    DocumentStatus @default(PENDING)
  verificationNotes String?

  uploadedAt DateTime @default(now())
  verifiedAt DateTime?

  @@map("trainee_documents")
  @@index([registrationId])
  @@index([documentTypeId])
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Certificate {
  id        String   @id @default(cuid())
  registrationId String @unique
  certificateNumber String @unique
  issuedDate DateTime
  validUntil DateTime?
  fileUrl   String?
  verificationCode String @unique // For public verification

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("certificates")
  @@index([verificationCode])
}

model Region {
  id        String   @id @default(cuid())
  name      String   @unique  // Province name
  code      String   @unique

  // Relations
  regencies Regency[] @relation("RegionToRegency")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("regions")
}

model Regency {
  id        String   @id @default(cuid())
  regionId  String
  region    Region   @relation("RegionToRegency", fields: [regionId], references: [id], onDelete: Cascade)
  name      String   // Regency/City name
  code      String

  // Relations
  districts District[] @relation("RegencyToDistrict")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([regionId, code])
  @@map("regencies")
}

model District {
  id        String   @id @default(cuid())
  regencyId String
  regency   Regency  @relation("RegencyToDistrict", fields: [regencyId], references: [id], onDelete: Cascade)
  name      String   // District/Sub-district name
  code      String

  // Relations
  villages  Village[] @relation("DistrictToVillage")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([regencyId, code])
  @@map("districts")
}

model Village {
  id        String   @id @default(cuid())
  districtId String
  district  District @relation("DistrictToVillage", fields: [districtId], references: [id], onDelete: Cascade)
  name      String   // Village/Sub-village name
  code      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([districtId, code])
  @@map("villages")
}

model PIC {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phoneNumber String
  department String?
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pics")
}

model Marketing {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phoneNumber String
  region    String?  // Region responsible for
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("marketing")
}

model Notification {
  id        String   @id @default(cuid())
  type      NotificationType
  recipient String  // email or phone
  subject   String?
  content   String
  status    NotificationStatus @default(PENDING)
  sentAt    DateTime?
  failureReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notifications")
  @@index([status])
  @@index([createdAt])
}

enum NotificationType {
  EMAIL
  WHATSAPP
  SMS
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

// ============================================================================
// AUDIT & LOGGING
// ============================================================================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserToAuditLog", fields: [userId], references: [id], onDelete: SetNull)
  action    String   // e.g., "CREATE_LINK", "APPROVE_REGISTRATION"
  description String?
  targetId  String?  // ID of affected entity
  oldValue  Json?
  newValue  Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
